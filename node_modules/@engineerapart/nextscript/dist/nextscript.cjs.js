"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var PropTypes=_interopDefault(require("prop-types")),React=_interopDefault(require("react")),terser=_interopDefault(require("terser"));const generateFeatureChecks=(e=[])=>e.map(e=>e.test?`${e.test} || _nextscript_feats.push('${e.feature}');`:`_nextscript_feats.push('${e.feature}');`).join("\n"),featureDetect=({scripts:e,minify:t=!0,allowUserMonitoring:n=!0,useFeatureDetection:r=!0,features:s=[]})=>{const i=`gated${r?",always":""}`,c=r?"&ua=chrome/76.0.0":"";return`\n  var _nextscript_feats = [];\n  if (${r}) {\n    ${generateFeatureChecks(s)}\n  } else {\n    _nextscript_feats.push('default');\n  }\n\n  function cs(src, isAsync, useHead, nonce, id) {\n    var s = document.createElement('script');\n    s.src = src;\n    s.async = isAsync;\n    if (nonce) { s.nonce = nonce; }\n    if (id){ s.id = id; }\n    if (useHead) {\n      document.head.appendChild(s);\n    } else {\n      document.body.appendChild(s);\n    }\n  }\n\n  if (_nextscript_feats.length) {\n    // Include a 'ua' argument set to a browser requiring no polyfills to skip UA identification\n    // (improves response time) and avoid being treated as unknown UA (which would\n    // otherwise result in no polyfills, even with 'always', if UA is unknown). Force always\n    // since our feature detection already told us we need them.\n    var src = 'https://cdn.polyfill.io/v2/polyfill.${t?"min.":""}js?features=' + _nextscript_feats.join(',') + '&flags=${i}&rum=${n?1:0}${c}&callback=_nspolyfillComplete';\n    cs(src, true, true);\n  } else {\n    _nspolyfillComplete();\n  }\n\n  function _nspolyfillComplete() {\n    var scripts = [${e}];\n    for (var i = 0; i < scripts.length; i++) {\n      cs(scripts[i].src, scripts[i].async, false, scripts[i].nonce, scripts[i].id);\n    }\n  }\n  `},ESCAPE_LOOKUP={"&":"\\u0026",">":"\\u003e","<":"\\u003c","\u2028":"\\u2028","\u2029":"\\u2029"},ESCAPE_REGEX=/[&><\u2028\u2029]/g;function htmlEscapeJsonString(e){return e.replace(ESCAPE_REGEX,e=>ESCAPE_LOOKUP[e])}const CLIENT_STATIC_FILES_PATH="static",CLIENT_STATIC_FILES_RUNTIME="runtime",CLIENT_STATIC_FILES_RUNTIME_PATH="static/runtime",CLIENT_STATIC_FILES_RUNTIME_AMP="static/runtime/amp.js",CLIENT_STATIC_FILES_RUNTIME_WEBPACK="static/runtime/webpack.js";class NextScript extends React.Component{getDynamicChunks(){const{dynamicImports:e,assetPrefix:t}=this.context._documentProps,{_devOnlyInvalidateCacheQueryString:n}=this.context;return e.map(e=>({key:e.file,src:`${t}/_next/${e.file}${n}`,async:!0,nonce:this.props.nonce,crossOrigin:this.props.crossOrigin||process.crossOrigin}))}getScripts(){const{assetPrefix:e,files:t}=this.context._documentProps;if(!t||0===t.length)return[];const{_devOnlyInvalidateCacheQueryString:n}=this.context;return t.map(t=>/\.js$/.exec(t)?{key:t,src:`${e}/_next/${t}${n}`,nonce:this.props.nonce,async:!0,crossOrigin:this.props.crossOrigin||process.crossOrigin}:null).filter(Boolean)}static getInlineScriptSource(e){const{__NEXT_DATA__:t}=e;try{return htmlEscapeJsonString(JSON.stringify(t))}catch(n){if(n.message.indexOf("circular structure"))throw new Error(`Circular structure in "getInitialProps" result of page "${t.page}". https://err.sh/zeit/next.js/circular-structure`);throw n}}getPageScripts(){const{staticMarkup:e,assetPrefix:t,__NEXT_DATA__:n}=this.context._documentProps,{_devOnlyInvalidateCacheQueryString:r}=this.context,{page:s,buildId:i,dynamicBuildId:c}=n,o=this.props.crossOrigin||process.crossOrigin,a=[],p=t+(c?`/_next/static/client/pages/_app.${i}.js`:`/_next/static/${i}/pages/_app.js`)+r,l=t+(c?`/_next/static/client/pages${getPageFile(s,i)}`:`/_next/static/${i}/pages${getPageFile(s)}`)+r;return"/_error"!==s&&a.push({src:l,async:!0,nonce:this.props.nonce,id:`__NEXT_PAGE__${s}`,crossOrigin:o}),a.push({src:p,async:!0,nonce:this.props.nonce,id:"__NEXT_PAGE__/_app",crossOrigin:o}),e||(a.push(...this.getDynamicChunks()),a.push(...this.getScripts())),a}injectScripts(e){const{nonce:t,allowUserMonitoring:n,minify:r,useFeatureDetection:s,features:i,preLoadScripts:c,postLoadScripts:o}=this.props,a=e=>{const n={src:e.src,async:e.async||void 0,nonce:e.nonce||t||void 0,id:e.id||void 0,crossOrigin:e.crossOrigin||void 0};return JSON.stringify(n)},p=[...(c||[]).map(a),...e.map(a),...(o||[]).map(a)];return featureDetect({scripts:`\n${p.join(",\n")}\n`,allowUserMonitoring:n,minify:r,useFeatureDetection:s,features:i})}requiresPreloading(){const{useFeatureDetection:e,features:t,preloadPolyfills:n}=this.props;return n&&(e||Array.isArray(t)&&t.length>0)}render(){const{staticMarkup:e,assetPrefix:t,amphtml:n,devFiles:r}=this.context._documentProps,{_devOnlyInvalidateCacheQueryString:s}=this.context,{nonce:i}=this.props,c=this.props.crossOrigin||process.crossOrigin,o=this.getPageScripts(),a=this.requiresPreloading()?terser.minify(this.injectScripts(o)).code:null;if(n){if("production"===process.env.NODE_ENV)return null;const n=[CLIENT_STATIC_FILES_RUNTIME_AMP,CLIENT_STATIC_FILES_RUNTIME_WEBPACK];return React.createElement(React.Fragment,null,e?null:React.createElement("script",{id:"__NEXT_DATA__",type:"application/json",nonce:i,crossOrigin:c,dangerouslySetInnerHTML:{__html:NextScript.getInlineScriptSource(this.context._documentProps)},"data-amp-development-mode-only":!0}),n?n.map(e=>React.createElement("script",{key:e,src:`${t}/_next/${e}${s}`,nonce:i,crossOrigin:c,"data-amp-development-mode-only":!0})):null)}return React.createElement(React.Fragment,null,r?r.map(e=>React.createElement("script",{key:e,src:`${t}/_next/${e}${s}`,nonce:i,crossOrigin:c})):null,e?null:React.createElement("script",{id:"__NEXT_DATA__",type:"application/json",nonce:i,crossOrigin:c,dangerouslySetInnerHTML:{__html:NextScript.getInlineScriptSource(this.context._documentProps)}}),a&&React.createElement("script",{id:"__next-preloader",nonce:i,dangerouslySetInnerHTML:{__html:a}}),!a&&o.map((e,t)=>{const n={src:e.src,async:e.async||void 0,nonce:e.nonce||i||void 0,id:e.id||void 0};return React.createElement("script",Object.assign({},n,{key:t}))}))}}function getPageFile(e,t){return"/"===e?t?`/index.${t}.js`:"/index.js":t?`${e}.${t}.js`:`${e}.js`}NextScript.contextTypes={_documentProps:PropTypes.any,_devOnlyInvalidateCacheQueryString:PropTypes.string},NextScript.defaultProps={allowUserMonitoring:!0,minify:!0,preLoadScripts:[],postLoadScripts:[],useFeatureDetection:!0,features:[],preloadPolyfills:!0};const FeaturePolyfills={DEFAULT:{test:null,feature:"default"},ES6:{test:null,feature:"es6"},ES2015:{test:null,feature:"es2015"},FETCH:{test:"('fetch' in window)",feature:"fetch"},INTERSECTIONOBSERVER:{test:"('IntersectionObserver' in window)",feature:"IntersectionObserver"},CUSTOMEVENT:{test:"(typeof CustomEvent === 'function')",feature:"CustomEvent"},OBJECT_ASSIGN:{test:"('assign' in Object)",feature:"Object.assign"},ARRAY_FROM:{test:"('from' in Array)",feature:"Array.from"},ARRAY_FIND:{test:"('find' in Array.prototype)",feature:"Array.prototype.find"},ARRAY_FINDINDEX:{test:"('findIndex' in Array.prototype)",feature:"Array.prototype.findIndex"},ARRAY_FILL:{test:"('fill' in Array.prototype)",feature:"Array.prototype.fill"},ARRAY_INCLUDES:{test:"('includes' in Array.prototype)",feature:"Array.prototype.includes"},REQUESTANIMATIONFRAME:{test:"('requestAnimationFrame' in window)",feature:"requestAnimationFrame"},INTL:{test:"('Intl' in window)",feature:"Intl"}};exports.FeaturePolyfills=FeaturePolyfills,exports.NextScript=NextScript;
